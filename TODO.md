# TODO - Next 10 High-Leverage Actions

> **Last Updated:** December 27, 2025 12:45 UTC
> **Documentation Recency Validated:** December 27, 2025
> **Generated by:** Claude with temporal metacognition

---

## Overview

| # | Action | Confidence | Subtasks | Status |
|---|--------|------------|----------|--------|
| 1 | Session Persistence Validation | 98% | 10 | ✅ Complete |
| 2 | Sentry Error Boundary Integration | 95% | 10 | ✅ Complete |
| 3 | Keyboard Navigation for Cards | 92% | 12 | ✅ Complete |
| 4 | Memoization & Memory Leak Fixes | 90% | 15 | ✅ Complete |
| 5 | Unit Tests for Core Hooks | 88% | 18 | ✅ Complete |
| 6 | Input Validation with Zod Schemas | 94% | 12 | ✅ Complete |
| 7 | Error Handling Improvements | 87% | 14 | ✅ Complete |
| 8 | Edge Function Integration Tests | 85% | 16 | Pending |
| 9 | Reduced Motion Support | 90% | 10 | ✅ Complete |
| 10 | API Timeout & Retry Logic | 82% | 12 | ✅ Complete |

---

## Action 1: Session Persistence Validation

**Confidence: 98%** | **Priority: CRITICAL** | **Effort: Medium**

### Problem
`JSON.parse(savedSession)` in `useSessionPersistence.ts:145` parses untrusted localStorage data without schema validation. Malicious session data could corrupt application state.

### Research Citations
- [Zod localStorage Security (Medium, 2025)](https://medium.com/@michu2k/validate-data-in-browser-storage-with-zod-be254f465a40)
- [zod-localstorage npm package](https://www.npmjs.com/package/zod-localstorage)
- [Schema Validation with Zod (Turing, 2025)](https://www.turing.com/blog/data-integrity-through-zod-validation)

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 1.1 | Create sessionDataSchema with Zod | `src/types/schemas.ts` | 20min |
| 1.2 | Create safeJsonParse utility | `src/lib/utils.ts` | 15min |
| 1.3 | Update useSessionPersistence to use safeParse | `src/hooks/useSessionPersistence.ts` | 30min |
| 1.4 | Add graceful degradation on parse failure | `src/hooks/useSessionPersistence.ts` | 15min |
| 1.5 | Add toast notification on corrupted session | `src/hooks/useSessionPersistence.ts`, `src/hooks/use-toast.ts` | 10min |
| 1.6 | Create unit tests for safeJsonParse | `src/lib/__tests__/utils.test.ts` | 30min |
| 1.7 | Add session data version migration | `src/hooks/useSessionPersistence.ts` | 20min |
| 1.8 | Implement optional localStorage encryption | `src/lib/crypto.ts` | 45min |
| 1.9 | Add session integrity hash verification | `src/hooks/useSessionPersistence.ts`, `src/lib/crypto.ts` | 30min |
| 1.10 | Document session security in CLAUDE.md | `CLAUDE.md` | 10min |

---

## Action 2: Sentry Error Boundary Integration

**Confidence: 95%** | **Priority: HIGH** | **Effort: Low**

### Problem
`ErrorBoundary.componentDidCatch()` only logs to console. Production errors are untracked, preventing incident diagnosis.

### Research Citations
- [Sentry React Error Boundary Docs (Official, 2025)](https://docs.sentry.io/platforms/javascript/guides/react/features/error-boundary/)
- [Advanced Error Tracking in React (Medium, 2025)](https://medium.com/@ignatovich.dm/integrating-sentry-with-react-advanced-error-tracking-and-handling-0f88c2d322c0)
- [Guide to Error Handling in React (Sentry Blog)](https://blog.sentry.io/guide-to-error-and-exception-handling-in-react/)

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 2.1 | Import Sentry in error boundary | `src/components/ui/error-boundary.tsx` | 5min |
| 2.2 | Add Sentry.captureException in componentDidCatch | `src/components/ui/error-boundary.tsx` | 10min |
| 2.3 | Add React error info context | `src/components/ui/error-boundary.tsx` | 10min |
| 2.4 | Add user context (userId, plan) to Sentry | `src/components/ui/error-boundary.tsx` | 15min |
| 2.5 | Create error fingerprinting for deduplication | `src/components/ui/error-boundary.tsx` | 15min |
| 2.6 | Add breadcrumbs for last user actions | `src/components/ui/error-boundary.tsx` | 20min |
| 2.7 | Create custom Sentry tags for spec stage | `src/components/ui/error-boundary.tsx` | 10min |
| 2.8 | Add Sentry feedback widget on error | `src/components/ui/error-boundary.tsx` | 20min |
| 2.9 | Create unit tests for error boundary | `src/components/ui/__tests__/error-boundary.test.tsx` | 30min |
| 2.10 | Document error tracking in CLAUDE.md | `CLAUDE.md` | 10min |

---

## Action 3: Keyboard Navigation for Cards

**Confidence: 92%** | **Priority: HIGH** | **Effort: Medium**

### Problem
8 interactive card components use `onClick` without keyboard support. Screen reader and keyboard-only users cannot access core functionality.

### Research Citations
- [ARIAKit at React Advanced 2025 (InfoQ)](https://www.infoq.com/news/2025/12/accessibility-ariakit-react/)
- [WCAG 2.2 Requirements 2025 (Elementor)](https://elementor.com/blog/wcag-2-2/)
- [Keyboard Accessibility in React (freeCodeCamp)](https://www.freecodecamp.org/news/designing-keyboard-accessibility-for-complex-react-experiences/)

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 3.1 | Create reusable InteractiveCard wrapper | `src/components/ui/interactive-card.tsx` | 30min |
| 3.2 | Add keyboard handler utility (Enter/Space) | `src/lib/a11y.ts` | 15min |
| 3.3 | Fix SampleSpecGallery card accessibility | `src/components/SampleSpecGallery.tsx` | 20min |
| 3.4 | Fix ExpertCard expand/collapse accessibility | `src/components/ExpertCard.tsx` | 20min |
| 3.5 | Fix TechStackCard selection accessibility | `src/components/TechStackCard.tsx` | 20min |
| 3.6 | Fix ExpandableAgentCard accessibility | `src/components/ExpandableAgentCard.tsx` | 20min |
| 3.7 | Fix MobileHeader agent selection | `src/components/mobile/MobileHeader.tsx` | 15min |
| 3.8 | Fix ChatMessage avatar click | `src/components/chat/ChatMessage.tsx` | 15min |
| 3.9 | Add visible focus indicators (focus-visible) | `src/index.css` | 15min |
| 3.10 | Add aria-pressed for toggle states | `src/components/ExpertCard.tsx`, `src/components/TechStackCard.tsx` | 20min |
| 3.11 | Create a11y Playwright tests | `tests/accessibility-keyboard.spec.ts` | 45min |
| 3.12 | Document a11y patterns in CLAUDE.md | `CLAUDE.md` | 15min |

---

## Action 4: Memoization & Memory Leak Fixes

**Confidence: 90%** | **Priority: HIGH** | **Effort: Medium**

### Problem
AgentCard event listener leak (2-5MB), unmemoized text parsing, ChatMessage re-renders cause performance degradation on mobile.

### Research Citations
- Internal audit findings from parallel exploration agents
- React performance best practices (useMemo, useCallback, React.memo)

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 4.1 | Fix AgentCard event listener leak | `src/components/AgentCard.tsx` | 20min |
| 4.2 | Memoize LiveAgentCard text parsing | `src/components/LiveAgentCard.tsx` | 15min |
| 4.3 | Optimize getTagsFromText toLowerCase | `src/components/LiveAgentCard.tsx` | 10min |
| 4.4 | Add React.memo to ChatMessage | `src/components/chat/ChatMessage.tsx` | 10min |
| 4.5 | Memoize ChatMessage callbacks | `src/components/chat/ChatMessage.tsx` | 15min |
| 4.6 | Extract default tech stack to constant | `src/components/SpecOutput.tsx` | 10min |
| 4.7 | Add lazy initialization for techStack | `src/components/SpecOutput.tsx` | 10min |
| 4.8 | Create memoized DialogueEntryItem | `src/components/DialoguePanel.tsx` | 25min |
| 4.9 | Cache scroll viewport with useRef | `src/components/chat/ChatView.tsx` | 15min |
| 4.10 | Add loading="lazy" to avatar images | `src/components/AgentCard.tsx` | 5min |
| 4.11 | Create shared avatar imports module | `src/lib/avatars.ts` | 20min |
| 4.12 | Update AgentCard to use shared avatars | `src/components/AgentCard.tsx`, `src/lib/avatars.ts` | 10min |
| 4.13 | Update ChatMessage to use shared avatars | `src/components/chat/ChatMessage.tsx`, `src/lib/avatars.ts` | 10min |
| 4.14 | Update LiveAgentCard to use shared avatars | `src/components/LiveAgentCard.tsx`, `src/lib/avatars.ts` | 10min |
| 4.15 | Update DialoguePanel to use shared avatars | `src/components/DialoguePanel.tsx`, `src/lib/avatars.ts` | 10min |

---

## Action 5: Unit Tests for Core Hooks

**Confidence: 88%** | **Priority: HIGH** | **Effort: High**

### Problem
Zero unit tests for 9 critical hooks including useSpecFlow (1400+ LOC). Refactoring risks breaking core functionality.

### Research Citations
- Vitest documentation for React Testing Library integration
- Testing best practices for React hooks (2025)

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 5.1 | Set up Vitest testing utilities | `src/test/setup.ts`, `vitest.config.ts` | 30min |
| 5.2 | Create Supabase mock utilities | `src/test/mocks/supabase.ts` | 30min |
| 5.3 | Create localStorage mock utilities | `src/test/mocks/storage.ts` | 20min |
| 5.4 | Test useSession reducer actions | `src/hooks/spec-generation/__tests__/use-session.test.ts` | 45min |
| 5.5 | Test useDialogue reducer actions | `src/hooks/spec-generation/__tests__/use-dialogue.test.ts` | 30min |
| 5.6 | Test useTasks reducer actions | `src/hooks/spec-generation/__tests__/use-tasks.test.ts` | 30min |
| 5.7 | Test useSpecFlow stage transitions | `src/hooks/spec-generation/__tests__/use-spec-flow.test.ts` | 60min |
| 5.8 | Test useSpecFlow error handling | `src/hooks/spec-generation/__tests__/use-spec-flow.test.ts` | 45min |
| 5.9 | Test useSpecFlow pause/resume | `src/hooks/spec-generation/__tests__/use-spec-flow.test.ts` | 30min |
| 5.10 | Test useSessionPersistence debounce | `src/hooks/__tests__/useSessionPersistence.test.ts` | 45min |
| 5.11 | Test useSessionPersistence quota | `src/hooks/__tests__/useSessionPersistence.test.ts` | 30min |
| 5.12 | Test useSessionPersistence expiry | `src/hooks/__tests__/useSessionPersistence.test.ts` | 30min |
| 5.13 | Test useAuth state management | `src/hooks/__tests__/useAuth.test.ts` | 45min |
| 5.14 | Test useAuth session refresh | `src/hooks/__tests__/useAuth.test.ts` | 30min |
| 5.15 | Test useProfile fetching | `src/hooks/__tests__/use-profile.test.ts` | 30min |
| 5.16 | Test useProfile upgrade flow | `src/hooks/__tests__/use-profile.test.ts` | 30min |
| 5.17 | Test use-toast memory management | `src/hooks/__tests__/use-toast.test.ts` | 20min |
| 5.18 | Add CI workflow for unit tests | `.github/workflows/test.yml` | 20min |

---

## Action 6: Input Validation with Zod Schemas

**Confidence: 94%** | **Priority: HIGH** | **Effort: Medium**

### Problem
User inputs passed to Edge Functions without client-side Zod validation. XSS risks in URL construction. Chat has no length limits.

### Research Citations
- [Zod GitHub Documentation (Official)](https://github.com/colinhacks/zod)
- [Schema Validation with Zod (Turing, 2025)](https://www.turing.com/blog/data-integrity-through-zod-validation)

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 6.1 | Create comprehensive input schemas | `src/types/schemas.ts` | 30min |
| 6.2 | Add userInput schema (25-5000 chars) | `src/types/schemas.ts` | 10min |
| 6.3 | Add chatMessage schema (1-2000 chars) | `src/types/schemas.ts` | 10min |
| 6.4 | Add URL validation schema | `src/types/schemas.ts` | 15min |
| 6.5 | Validate input in api.ts before invoke | `src/lib/api.ts`, `src/types/schemas.ts` | 20min |
| 6.6 | Add URL validation to TechStackCard | `src/components/TechStackCard.tsx` | 20min |
| 6.7 | Add domain whitelist for tech logos | `src/components/TechStackCard.tsx` | 15min |
| 6.8 | Add chat input validation in ChatInput | `src/components/chat/ChatInput.tsx` | 15min |
| 6.9 | Add validation error UI feedback | `src/components/SimpleSpecInput.tsx` | 20min |
| 6.10 | Create validation error toast utility | `src/lib/validation.ts` | 15min |
| 6.11 | Test schema edge cases | `src/types/__tests__/schemas.test.ts` | 30min |
| 6.12 | Document validation in CLAUDE.md | `CLAUDE.md` | 10min |

---

## Action 7: Error Handling Improvements

**Confidence: 87%** | **Priority: MEDIUM** | **Effort: Medium**

### Problem
FileReader errors unhandled, canvas.toBlob silent failures, empty catch blocks, missing partial failure notifications.

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 7.1 | Add FileReader error handling in SpecInput | `src/components/SpecInput.tsx` | 20min |
| 7.2 | Add FileReader error handling in SimpleSpecInput | `src/components/SimpleSpecInput.tsx` | 20min |
| 7.3 | Add canvas render error handling | `src/components/SpecOutput.tsx` | 25min |
| 7.4 | Add blob validation before download | `src/components/SpecOutput.tsx` | 15min |
| 7.5 | Replace empty catch with error logging | `src/hooks/useSessionPersistence.ts` | 15min |
| 7.6 | Add partial failure notification | `src/hooks/spec-generation/use-spec-flow.ts` | 25min |
| 7.7 | Track failure rate in parallel executor | `supabase/functions/lib/parallel-executor.ts` | 20min |
| 7.8 | Add getSession error handling | `src/hooks/useAuth.ts` | 15min |
| 7.9 | Add await to fetchProfile after upgrade | `src/hooks/use-profile.ts` | 10min |
| 7.10 | Improve SpecView error messages | `src/pages/SpecView.tsx` | 15min |
| 7.11 | Add response.json() error handling | `supabase/functions/voice-to-text/index.ts` | 15min |
| 7.12 | Add req.json() error handling | `supabase/functions/multi-agent-spec/index.ts` | 15min |
| 7.13 | Create error categorization utility | `src/lib/errors.ts` | 25min |
| 7.14 | Test error scenarios | `tests/error-handling.spec.ts` | 45min |

---

## Action 8: Edge Function Integration Tests

**Confidence: 85%** | **Priority: HIGH** | **Effort: High**

### Problem
No tests for 8-stage multi-agent-spec pipeline or payment flow. Bugs cause revenue loss.

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 8.1 | Create Deno test configuration | `supabase/functions/deno.json` | 20min |
| 8.2 | Create mock LLM responses | `supabase/functions/tests/mocks/llm.ts` | 30min |
| 8.3 | Create mock Supabase client | `supabase/functions/tests/mocks/supabase.ts` | 30min |
| 8.4 | Test questions stage | `supabase/functions/tests/multi-agent-spec.test.ts` | 30min |
| 8.5 | Test research stage | `supabase/functions/tests/multi-agent-spec.test.ts` | 30min |
| 8.6 | Test challenge stage | `supabase/functions/tests/multi-agent-spec.test.ts` | 30min |
| 8.7 | Test synthesis stage | `supabase/functions/tests/multi-agent-spec.test.ts` | 30min |
| 8.8 | Test review stage | `supabase/functions/tests/multi-agent-spec.test.ts` | 30min |
| 8.9 | Test voting stage | `supabase/functions/tests/multi-agent-spec.test.ts` | 30min |
| 8.10 | Test spec stage | `supabase/functions/tests/multi-agent-spec.test.ts` | 30min |
| 8.11 | Test chat stage | `supabase/functions/tests/multi-agent-spec.test.ts` | 30min |
| 8.12 | Test rate limiting | `supabase/functions/tests/multi-agent-spec.test.ts` | 20min |
| 8.13 | Test voice-to-text validation | `supabase/functions/tests/voice-to-text.test.ts` | 30min |
| 8.14 | Test voice-to-text errors | `supabase/functions/tests/voice-to-text.test.ts` | 25min |
| 8.15 | Test upgrade-to-pro flow | `supabase/functions/tests/upgrade-to-pro.test.ts` | 30min |
| 8.16 | Add edge function tests to CI | `.github/workflows/test.yml` | 20min |

---

## Action 9: Reduced Motion Support

**Confidence: 90%** | **Priority: MEDIUM** | **Effort: Low**

### Problem
AgentCard 3D tilt and Framer Motion animations don't respect `prefers-reduced-motion`. Users with vestibular disorders affected.

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 9.1 | Create useReducedMotion hook | `src/hooks/use-reduced-motion.ts` | 15min |
| 9.2 | Disable AgentCard tilt on reduced motion | `src/components/AgentCard.tsx` | 15min |
| 9.3 | Create motion-safe variants for Framer | `src/lib/motion.ts` | 25min |
| 9.4 | Update DialoguePanel animations | `src/components/DialoguePanel.tsx` | 15min |
| 9.5 | Update ChatView animations | `src/components/chat/ChatView.tsx` | 15min |
| 9.6 | Update LiveAgentCard animations | `src/components/LiveAgentCard.tsx` | 15min |
| 9.7 | Add CSS reduced motion fallbacks | `src/index.css` | 15min |
| 9.8 | Test with reduced motion enabled | `tests/accessibility-motion.spec.ts` | 30min |
| 9.9 | Document motion preferences | `CLAUDE.md` | 10min |
| 9.10 | Plan settings toggle (future) | `docs/ROADMAP.md` | 10min |

---

## Action 10: API Timeout & Retry Logic

**Confidence: 82%** | **Priority: MEDIUM** | **Effort: Medium**

### Problem
AbortController timeout doesn't work with Supabase client. 35-minute operations can hang indefinitely.

### Alternative Approach (18% consideration)
Use TanStack Query's built-in retry with exponential backoff instead of custom implementation.

### Atomic Subtasks

| # | Task | Files (≤5) | Est. |
|---|------|------------|------|
| 10.1 | Verify Supabase signal support | `src/lib/api.ts` | 15min |
| 10.2 | Implement manual timeout wrapper | `src/lib/api.ts` | 30min |
| 10.3 | Add timeout error differentiation | `src/lib/api.ts` | 15min |
| 10.4 | Create retry utility with backoff | `src/lib/retry.ts` | 30min |
| 10.5 | Add retry for transient failures | `src/lib/api.ts`, `src/lib/retry.ts` | 25min |
| 10.6 | Add timeout progress indicator | `src/components/ProcessViewer.tsx` | 25min |
| 10.7 | Add cancel button for long operations | `src/components/ProcessViewer.tsx` | 30min |
| 10.8 | Implement request cancellation | `src/hooks/spec-generation/use-spec-flow.ts` | 35min |
| 10.9 | Add offline detection | `src/lib/network.ts` | 20min |
| 10.10 | Show offline banner | `src/App.tsx`, `src/lib/network.ts` | 25min |
| 10.11 | Test timeout scenarios | `tests/api-timeout.spec.ts` | 45min |
| 10.12 | Document timeout behavior | `CLAUDE.md` | 10min |

---

## Implementation Timeline

### Week 1 (Critical Security & Observability)
- [ ] Action 1: Session Persistence Validation
- [ ] Action 2: Sentry Error Boundary Integration

### Week 2 (Accessibility & Performance)
- [ ] Action 3: Keyboard Navigation for Cards
- [ ] Action 4: Memoization & Memory Leak Fixes

### Week 3 (Security & Resilience)
- [ ] Action 6: Input Validation with Zod
- [ ] Action 7: Error Handling Improvements

### Week 4 (Testing Foundation)
- [ ] Action 5: Unit Tests for Core Hooks
- [ ] Action 8: Edge Function Integration Tests

### Week 5 (Polish)
- [ ] Action 9: Reduced Motion Support
- [ ] Action 10: API Timeout & Retry Logic

---

# Next 10 High-Leverage Actions (Phase 2)

## Overview

| # | Action | Confidence | Status |
|---|--------|------------|--------|
| 11 | Dependency Updates & Maintenance | 96% | ✅ Complete |
| 12 | Core Web Vitals & Performance Monitoring | 94% | ✅ Complete |
| 13 | Database Query Optimization & Indices | 92% | ✅ Complete |
| 14 | Product Analytics & User Tracking | 90% | ✅ Complete |
| 15 | Large Component Refactoring (SpecOutput) | 88% | ✅ Complete |
| 16 | Content Security Policy & Security Headers | 91% | ✅ Complete |
| 17 | Payment Integration (Stripe/Billing) | 87% | Pending |
| 18 | Environment Configuration & .env Validation | 89% | ✅ Complete |
| 19 | Component Documentation & Storybook | 85% | Pending |
| 20 | ESLint & Code Quality Enhancement | 86% | ✅ Complete |

---

## Action 11: Dependency Updates & Maintenance Strategy

**Confidence: 96%** | **Priority: CRITICAL** | **Effort: Medium**

### Problem
22 direct dependencies are outdated. Missing structured update strategy creates security/compatibility debt.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 11.1 | Create .npmrc with strict version pinning | `.npmrc` |
| 11.2 | Run npm audit and document findings | Package docs |
| 11.3 | Update all @radix-ui packages to latest | `package.json` |
| 11.4 | Update @playwright/test 1.56 → 1.57 | `package.json` |
| 11.5 | Update @eslint packages | `package.json` |
| 11.6 | Update @hookform/resolvers | `package.json` |
| 11.7 | Test all functionality post-upgrade | `tests/**` |
| 11.8 | Add dependabot configuration | `.github/dependabot.yml` |
| 11.9 | Document upgrade process | `CLAUDE.md` |
| 11.10 | Add to CI/CD pipeline | `.github/workflows/ci.yml` |

---

## Action 12: Core Web Vitals & Performance Monitoring

**Confidence: 94%** | **Priority: HIGH** | **Effort: Medium**

### Problem
Zero tracking of Core Web Vitals (LCP, FID, CLS). No visibility into real-world performance.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 12.1 | Install web-vitals library | `package.json` |
| 12.2 | Create web-vitals reporting utility | `src/lib/web-vitals.ts` |
| 12.3 | Initialize Web Vitals in main.tsx | `src/main.tsx` |
| 12.4 | Report metrics to Sentry | `src/lib/web-vitals.ts` |
| 12.5 | Add bundle size analyzer to build | `vite.config.ts` |
| 12.6 | Document performance targets | `docs/PERFORMANCE_TARGETS.md` |
| 12.7 | Create performance monitoring tests | `tests/performance.spec.ts` |

---

## Action 13: Database Query Optimization & Indices

**Confidence: 92%** | **Priority: HIGH** | **Effort: Medium**

### Problem
Specifications table missing indices for common queries (user_id, created_at, is_public).

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 13.1 | Add index on specifications(user_id) | `supabase/migrations/*.sql` |
| 13.2 | Add compound index on (user_id, created_at) | `supabase/migrations/*.sql` |
| 13.3 | Add index on specifications(is_public) | `supabase/migrations/*.sql` |
| 13.4 | Enable query logging in Supabase | Supabase config |
| 13.5 | Analyze slow queries report | Documentation |
| 13.6 | Add RLS policy indices | `supabase/migrations/*.sql` |
| 13.7 | Document query patterns | `docs/DATABASE.md` |

---

## Action 14: Product Analytics & User Tracking

**Confidence: 90%** | **Priority: HIGH** | **Effort: High**

### Problem
Zero product analytics. No visibility into feature usage, conversion funnel, or user segments.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 14.1 | Implement PostHog or Mixpanel SDK | `src/lib/analytics.ts` |
| 14.2 | Track spec generation start events | `src/hooks/spec-generation/use-spec-flow.ts` |
| 14.3 | Track spec generation completion | `src/hooks/spec-generation/use-spec-flow.ts` |
| 14.4 | Track stage progression | `src/hooks/spec-generation/use-spec-flow.ts` |
| 14.5 | Track export/download events | `src/components/SpecOutput.tsx` |
| 14.6 | Track chat interactions | `src/components/chat/ChatView.tsx` |
| 14.7 | Document analytics events | `docs/ANALYTICS_EVENTS.md` |

---

## Action 15: Large Component Refactoring (SpecOutput)

**Confidence: 88%** | **Priority: MEDIUM** | **Effort: High**

### Problem
SpecOutput.tsx is 887 LOC. Markdown rendering, export logic, styling mixed together.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 15.1 | Extract markdown rendering | `src/components/SpecOutput/MarkdownRenderer.tsx` |
| 15.2 | Extract export logic to hook | `src/hooks/use-spec-export.ts` |
| 15.3 | Extract PDF generation | `src/lib/spec-exporters/pdf.ts` |
| 15.4 | Extract DOCX generation | `src/lib/spec-exporters/docx.ts` |
| 15.5 | Extract tech stack display | `src/components/SpecOutput/TechStackDisplay.tsx` |
| 15.6 | Refactor SpecOutput to use sub-components | `src/components/SpecOutput.tsx` |
| 15.7 | Add unit tests for sub-components | `src/components/SpecOutput/__tests__/*.test.tsx` |

---

## Action 16: Content Security Policy & Security Headers

**Confidence: 91%** | **Priority: HIGH** | **Effort: Low**

### Problem
No CSP headers. Vulnerable to XSS, clickjacking, MIME-sniffing.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 16.1 | Create CSP policy for production | `vercel.json` or `netlify.toml` |
| 16.2 | Configure HSTS header | Deployment config |
| 16.3 | Add X-Frame-Options header | Deployment config |
| 16.4 | Add X-Content-Type-Options nosniff | Deployment config |
| 16.5 | Add Referrer-Policy header | Deployment config |
| 16.6 | Document CSP configuration | `docs/SECURITY_HEADERS.md` |
| 16.7 | Test headers with online tools | Manual testing |

---

## Action 17: Payment Integration (Stripe/Billing)

**Confidence: 87%** | **Priority: MEDIUM** | **Effort: High**

### Problem
upgrade-to-pro Edge Function has TODO comment. Payment verification incomplete.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 17.1 | Create Stripe integration module | `src/lib/stripe-client.ts` |
| 17.2 | Add Stripe webhook handler | `supabase/functions/stripe-webhook/index.ts` |
| 17.3 | Complete upgrade-to-pro function | `supabase/functions/upgrade-to-pro/index.ts` |
| 17.4 | Create payment form component | `src/components/PaymentForm.tsx` |
| 17.5 | Implement subscription status check | `src/hooks/use-subscription.ts` |
| 17.6 | Create billing history page | `src/pages/Billing.tsx` |
| 17.7 | Document payment flow | `docs/PAYMENT_FLOW.md` |

---

## Action 18: Environment Configuration & .env Validation

**Confidence: 89%** | **Priority: MEDIUM** | **Effort: Low**

### Problem
No .env.example file. No runtime validation of required environment variables.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 18.1 | Create .env.example template | `.env.example` |
| 18.2 | Document all required env vars | `docs/ENVIRONMENT_SETUP.md` |
| 18.3 | Create env validation utility | `src/lib/env-validation.ts` |
| 18.4 | Add validation to app initialization | `src/main.tsx` |
| 18.5 | Create validation error UI | `src/components/EnvValidationError.tsx` |
| 18.6 | Add zod schema for env vars | `src/types/env-schema.ts` |

---

## Action 19: Component Documentation & Storybook

**Confidence: 85%** | **Priority: MEDIUM** | **Effort: High**

### Problem
95+ components with no documentation or visual regression testing.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 19.1 | Install Storybook | `package.json`, `.storybook/main.ts` |
| 19.2 | Create Storybook config for Tailwind | `.storybook/main.ts` |
| 19.3 | Create stories for ui components | `src/components/ui/**/*.stories.tsx` |
| 19.4 | Create stories for page components | `src/components/**/*.stories.tsx` |
| 19.5 | Document component prop types | Stories |
| 19.6 | Deploy Storybook to Chromatic | `.github/workflows/storybook.yml` |

---

## Action 20: ESLint & Code Quality Enhancement

**Confidence: 86%** | **Priority: MEDIUM** | **Effort: Medium**

### Problem
ESLint rules don't enforce path alias usage. No forbidden patterns (console.log in prod).

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 20.1 | Add eslint-plugin-import for alias rules | `eslint.config.js` |
| 20.2 | Configure no-relative-imports rule | `eslint.config.js` |
| 20.3 | Add max-lines rule for components | `eslint.config.js` |
| 20.4 | Add forbidden console.log in production | `eslint.config.js` |
| 20.5 | Fix all existing violations | `src/**` |
| 20.6 | Add to pre-commit hooks | `.git/hooks/pre-commit` |
| 20.7 | Document code quality standards | `docs/CODE_QUALITY.md` |

---

## Documentation Recency Validation

| Document | Last Updated | Status |
|----------|--------------|--------|
| README.md | Dec 26, 2025 | ✅ Current |
| CLAUDE.md | Dec 26, 2025 | ✅ Current |
| CHANGELOG.md | Dec 27, 2025 | ✅ Current |
| package.json | Dec 26, 2025 | ✅ Current |

### External Documentation Validated
- [Sentry React Docs](https://docs.sentry.io/platforms/javascript/guides/react/) - ✅ Current (2025)
- [Zod GitHub](https://github.com/colinhacks/zod) - ✅ Current (v3.25)
- [WCAG 2.2 Guidelines](https://www.w3.org/TR/WCAG22/) - ✅ Current (2025)
- [ARIAKit](https://ariakit.org/) - ✅ Current (React Advanced 2025)
- [web-vitals](https://github.com/GoogleChrome/web-vitals) - ✅ Current (v4.x, 2025)
- [PostHog](https://posthog.com/docs) - ✅ Current (2025)

---

# Next 10 High-Leverage Actions (Phase 3)

## Overview

| # | Action | Confidence | Status |
|---|--------|------------|--------|
| 21 | Build Verification | 99% | ✅ Complete |
| 22 | Strengthen TypeScript Configuration | 96% | ✅ Complete |
| 23 | Request Deduplication & Caching | 94% | ✅ Complete |
| 24 | Smart Error Boundaries with Fallback UI | 93% | ✅ Complete |
| 25 | Consolidate Avatar System | 92% | ✅ Complete |
| 26 | Distributed Tracing for Spec Generation | 89% | ✅ Complete |
| 27 | localStorage Encryption | 88% | ✅ Complete |
| 28 | Performance Monitoring for Stages | 87% | ✅ Complete |
| 29 | Edge Function Integration Tests | 86% | ✅ Complete |
| 30 | Large Component Refactoring | 85% | ✅ Complete |

---

## Action 22: Strengthen TypeScript Configuration

**Confidence: 96%** | **Priority: HIGH** | **Effort: Low**

### Problem
TypeScript config had very permissive settings that masked type errors.

### Changes Made
- Enabled `noUnusedLocals: true` - Catch dead code
- Enabled `noUnusedParameters: true` - Catch unused params
- Enabled `noFallthroughCasesInSwitch: true` - Prevent switch bugs
- Enabled `forceConsistentCasingInFileNames: true` - Prevent import issues
- Enabled `noImplicitReturns: true` - Catch missing returns
- Documented roadmap to full `strict: true` mode

---

## Action 23: Request Deduplication & Caching

**Confidence: 94%** | **Priority: HIGH** | **Effort: Medium**

### Problem
API layer lacked request deduplication. Parallel agents making identical research queries wasted tokens/time.

### Changes Made
- **src/lib/request-cache.ts** - Request cache with deduplication
- `RequestCache` class with TTL-based caching
- `RequestDeduplicator` for parallel request deduplication
- Cache metrics tracking (hits, misses, deduped)
- LRU eviction when max entries reached
- Pattern-based cache invalidation

---

## Action 25: Consolidate Avatar System

**Confidence: 92%** | **Priority: MEDIUM** | **Effort: Low**

### Problem
Avatar imports duplicated across 7 components (56 import lines total).

### Changes Made
- **src/lib/avatars.ts** - Centralized avatar registry
- `getAgentAvatar(name, variant)` - Get avatar by agent name
- `normalizeAgentName(name)` - Handle name variations
- Support for both standard and transparent variants
- Legacy exports for backward compatibility
- TypeScript validation for agent names

---

## Action 24: Smart Error Boundaries with Fallback UI

**Confidence: 93%** | **Priority: HIGH** | **Effort: Medium**

### Problem
No specialized error boundaries for different contexts (spec generation, chat, export).

### Changes Made
- **src/components/error-boundaries.tsx** - Specialized error boundaries
- `SpecGenerationBoundary` - With retry and clear session options
- `ChatBoundary` - Lightweight chat error handling
- `ExportBoundary` - Export-specific error UI
- `PageBoundary` - Full-page error with navigation
- `useErrorBoundary` hook for function components
- `withErrorHandling` async wrapper utility

---

## Action 26: Distributed Tracing for Spec Generation

**Confidence: 89%** | **Priority: MEDIUM** | **Effort: High**

### Problem
No end-to-end tracing for 8-stage spec generation pipeline.

### Changes Made
- **src/lib/tracing.ts** - Distributed tracing utilities
- `SpecGenerationTracer` class with span management
- `generateTraceId()` / `generateSpanId()` - ID generation
- `getTraceHeaders()` - Headers for API propagation
- `TraceSummary` - Comprehensive trace reports
- Sentry integration for trace context

---

## Action 27: localStorage Encryption

**Confidence: 88%** | **Priority: MEDIUM** | **Effort: Medium**

### Problem
Session data stored in plaintext localStorage vulnerable to XSS.

### Changes Made
- **src/lib/secure-storage.ts** - Encrypted storage utilities
- `SecureStorage` class with AES-GCM encryption
- Web Crypto API for key derivation
- IndexedDB for secure key storage
- TTL support for automatic expiry
- Graceful fallback for non-encrypted data
- `migrateToEncrypted()` utility for existing data

---

## Action 28: Performance Monitoring for Stages

**Confidence: 87%** | **Priority: MEDIUM** | **Effort: Medium**

### Problem
No visibility into which stages are slow. Users don't know if app is stuck.

### Changes Made
- **src/lib/stage-performance.ts** - Stage performance tracker
- `StagePerformanceTracker` class with timing
- `STAGE_BENCHMARKS` - Expected durations per stage
- Progress estimation and ETA calculation
- Slow stage detection with callbacks
- Sentry integration for slow stage alerts
- Comprehensive performance reports

---

## Action 29: Edge Function Integration Tests

**Confidence: 86%** | **Priority: HIGH** | **Effort: Medium**

### Problem
Edge function utilities lacked unit test coverage. Security and logging modules untested.

### Changes Made
- **supabase/functions/lib/__tests__/security.test.ts** - Security utility tests
- Prompt injection detection tests (29 test cases)
- Input sanitization tests
- Error sanitization tests
- **supabase/functions/lib/__tests__/structured-logger.test.ts** - Logger tests
- Request ID generation tests
- Logger levels and metrics tests
- Pipeline tracing tests (24 test cases)
- Timer utility tests
- **supabase/functions/lib/__tests__/rate-limiter.test.ts** - Rate limiter tests
- Queue stats verification

---

## Action 30: Large Component Refactoring

**Confidence: 85%** | **Priority: MEDIUM** | **Effort: High**

### Problem
SpecOutput.tsx was 887 lines with embedded export logic. Hard to maintain and test.

### Changes Made
- **src/hooks/use-spec-export.ts** - Extracted export hook (250 lines)
- All export state management centralized
- All download functions (PDF, Word, Image, etc.)
- Memoized with proper dependencies
- Clean interface for consumers
- **src/lib/pdf-generator.ts** - Extracted PDF generation (280 lines)
- `generateSpecPdf()` async function
- Cover page generation
- Table of contents generation
- Content rendering
- Footer and page numbers
- Progress callbacks for UI
- **src/components/SpecOutput.tsx** - Reduced from 887 to 739 lines (17% reduction)
- Cleaner component with hook integration
- Better separation of concerns

---

## Documentation Recency Validation

| Document | Last Updated | Status |
|----------|--------------|--------|
| README.md | Dec 26, 2025 | ✅ Current |
| CLAUDE.md | Dec 26, 2025 | ✅ Current |
| CHANGELOG.md | Dec 27, 2025 | ✅ Current |
| package.json | Dec 27, 2025 | ✅ Current |

### External Documentation Validated
- [Sentry React Docs](https://docs.sentry.io/platforms/javascript/guides/react/) - ✅ Current (2025)
- [Zod GitHub](https://github.com/colinhacks/zod) - ✅ Current (v3.25)
- [WCAG 2.2 Guidelines](https://www.w3.org/TR/WCAG22/) - ✅ Current (2025)
- [ARIAKit](https://ariakit.org/) - ✅ Current (React Advanced 2025)
- [web-vitals](https://github.com/GoogleChrome/web-vitals) - ✅ Current (v4.x, 2025)
- [PostHog](https://posthog.com/docs) - ✅ Current (2025)
- [Stripe API Docs](https://stripe.com/docs/api) - ✅ Current (2025)
- [Lighthouse CI](https://github.com/GoogleChrome/lighthouse-ci) - ✅ Current (v0.15)

---

# Next 10 High-Leverage Actions (Phase 4)

## Overview

| # | Action | Confidence | Status |
|---|--------|------------|--------|
| 31 | Stripe Payment Integration | 92% | Pending |
| 32 | Console Cleanup & Logging | 95% | ✅ Complete |
| 33 | Strict TypeScript Mode | 88% | Pending |
| 34 | Lighthouse CI & Performance Budgets | 90% | ✅ Complete |
| 35 | Storybook Component Library | 87% | Pending |
| 36 | Database Monitoring | 84% | ✅ Complete |
| 37 | Visual Regression Testing | 86% | Pending |
| 38 | API Documentation & OpenAPI | 89% | ✅ Complete |
| 39 | Dead Code Detection & Cleanup | 87% | Pending |
| 40 | SLI/SLO & Error Budgets | 85% | ✅ Complete |

---

## Action 31: Stripe Payment Integration

**Confidence: 92%** | **Priority: CRITICAL** | **Effort: High**

### Problem
`upgrade-to-pro` Edge Function has TODO comment. Payment verification incomplete with placeholder stripe_customer_id generation.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 31.1 | Create Stripe client SDK wrapper | `src/lib/stripe-client.ts` |
| 31.2 | Implement checkout session creation | `supabase/functions/create-checkout/index.ts` |
| 31.3 | Add webhook handler for events | `supabase/functions/stripe-webhook/index.ts` |
| 31.4 | Verify payment before plan update | `supabase/functions/upgrade-to-pro/index.ts` |
| 31.5 | Create subscription status hook | `src/hooks/use-subscription.ts` |

---

## Action 32: Console Cleanup & Logging

**Confidence: 95%** | **Priority: HIGH** | **Effort: Medium**

### Problem
67 console.log/warn/error statements in production code. Exposes data and bloats bundle.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 32.1 | Create structured logging utility | `src/lib/logger.ts` |
| 32.2 | Replace console.error with Sentry | `src/**/*.ts{x}` |
| 32.3 | Replace console.log with structured logs | `src/**/*.ts{x}` |
| 32.4 | Add ESLint no-console enforcement | `eslint.config.js` |
| 32.5 | Add pre-commit hook for console detection | `.husky/pre-commit` |

---

## Action 33: Strict TypeScript Mode

**Confidence: 88%** | **Priority: HIGH** | **Effort: High**

### Problem
TypeScript has `strict: false` and `noImplicitAny: false`. Runtime type errors possible.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 33.1 | Enable noImplicitAny incrementally | `tsconfig.app.json` |
| 33.2 | Fix any types in hooks/ | `src/hooks/**/*.ts` |
| 33.3 | Fix any types in lib/ | `src/lib/**/*.ts` |
| 33.4 | Enable strictNullChecks | `tsconfig.app.json` |
| 33.5 | Enable full strict mode | `tsconfig.app.json` |

---

## Action 34: Lighthouse CI & Performance Budgets

**Confidence: 90%** | **Priority: HIGH** | **Effort: Medium**

### Problem
No automated Lighthouse audits. No performance budget enforcement in CI.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 34.1 | Set up Lighthouse CI action | `.github/workflows/lighthouse.yml` |
| 34.2 | Define performance budget thresholds | `lighthouserc.json` |
| 34.3 | Add bundle size analyzer | `vite.config.ts`, `package.json` |
| 34.4 | Create performance documentation | `docs/PERFORMANCE_BUDGET.md` |
| 34.5 | Add Lighthouse check to PR workflow | `.github/workflows/ci.yml` |

---

## Action 35: Storybook Component Library

**Confidence: 87%** | **Priority: MEDIUM** | **Effort: High**

### Problem
95+ components with zero documentation. No visual regression testing foundation.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 35.1 | Install and configure Storybook v8 | `package.json`, `.storybook/` |
| 35.2 | Write stories for UI primitives | `src/components/ui/**/*.stories.tsx` |
| 35.3 | Write stories for feature components | `src/components/**/*.stories.tsx` |
| 35.4 | Add accessibility testing | `.storybook/main.ts` |
| 35.5 | Deploy Storybook to Vercel | `.github/workflows/storybook.yml` |

---

## Action 36: Database Monitoring

**Confidence: 84%** | **Priority: HIGH** | **Effort: Medium**

### Problem
No query performance monitoring. No slow query logs. Indices exist but no observability.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 36.1 | Create database metrics collection | `src/lib/db-metrics.ts` |
| 36.2 | Implement slow query detection | `supabase/functions/lib/query-monitor.ts` |
| 36.3 | Add Sentry query duration tracking | `src/integrations/supabase/client.ts` |
| 36.4 | Create database health check | `supabase/functions/db-health/index.ts` |
| 36.5 | Document database targets | `docs/DATABASE_MONITORING.md` |

---

## Action 37: Visual Regression Testing

**Confidence: 86%** | **Priority: MEDIUM** | **Effort: High**

### Problem
23 E2E tests but no visual regression detection. UI changes break silently.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 37.1 | Set up Percy.io or Lost Pixel | `package.json`, `playwright.config.ts` |
| 37.2 | Take baseline screenshots | `tests/visual-regression.spec.ts` |
| 37.3 | Add mobile viewport variants | `tests/visual-regression.spec.ts` |
| 37.4 | Integrate with GitHub Actions | `.github/workflows/test.yml` |
| 37.5 | Document visual testing workflow | `docs/VISUAL_REGRESSION.md` |

---

## Action 38: API Documentation & OpenAPI

**Confidence: 89%** | **Priority: MEDIUM** | **Effort: Medium**

### Problem
Edge Functions undocumented. No automated OpenAPI schema. No Swagger UI.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 38.1 | Create OpenAPI 3.1 schema | `docs/api-schema.openapi.json` |
| 38.2 | Document multi-agent-spec endpoint | `docs/api-schema.openapi.json` |
| 38.3 | Generate TypeScript types from schema | `src/lib/api-types.ts` |
| 38.4 | Set up SwaggerUI | `docs/swagger-ui/index.html` |
| 38.5 | Deploy API docs | `.github/workflows/api-docs.yml` |

---

## Action 39: Dead Code Detection & Cleanup

**Confidence: 87%** | **Priority: MEDIUM** | **Effort: Medium**

### Problem
No automated dead code detection. Unused exports in 23+ files.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 39.1 | Install ts-unused-exports analyzer | `package.json` |
| 39.2 | Run scan and document findings | `scripts/dead-code-analyzer.ts` |
| 39.3 | Remove unused component exports | `src/components/**/*.tsx` |
| 39.4 | Remove unused utility exports | `src/lib/**/*.ts` |
| 39.5 | Add dead code CI check | `.github/workflows/code-quality.yml` |

---

## Action 40: SLI/SLO & Error Budgets

**Confidence: 85%** | **Priority: MEDIUM** | **Effort: Medium**

### Problem
No SLO/SLI tracking. Error budget undefined. No alerting thresholds.

### Atomic Subtasks

| # | Task | Files (≤5) |
|---|------|------------|
| 40.1 | Define SLOs (99.9% availability) | `docs/SLI_SLO.md` |
| 40.2 | Create SLI tracking utility | `src/lib/sli-tracker.ts` |
| 40.3 | Implement error budget calculation | `src/lib/sli-tracker.ts` |
| 40.4 | Set up Sentry alerts | `src/lib/sentry.ts` |
| 40.5 | Create incident response playbook | `docs/INCIDENT_RESPONSE.md` |

---

*This TODO.md is auto-regenerated at each turn per CLAUDE.md requirements.*
